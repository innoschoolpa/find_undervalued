"""
DART APIë¥¼ ì‚¬ìš©í•œ ì¬ë¬´ì •ë³´ ì¡°íšŒ ë° ì‹œê°€ì´ì•¡ ìƒìœ„ ì¢…ëª© ì¶”ì¶œ
"""

import requests
import time
import logging
from typing import List, Dict, Any, Optional
import yaml
import json
from datetime import datetime, timedelta
import xml.etree.ElementTree as ET

logger = logging.getLogger(__name__)

class DartDataProvider:
    """DART APIë¥¼ ì‚¬ìš©í•œ ì¬ë¬´ì •ë³´ ì¡°íšŒ í´ë˜ìŠ¤"""
    
    def __init__(self, config_path: str = "config.yaml"):
        """DART API ì´ˆê¸°í™”"""
        self.config = self._load_config(config_path)
        self.api_key = self._get_dart_api_key()
        self.base_url = 'https://opendart.fss.or.kr/api'
        self.timeout = 12
        
        if not self.api_key:
            logger.warning("DART API í‚¤ê°€ ì„¤ì •ë˜ì§€ ì•Šì•˜ìŠµë‹ˆë‹¤. config.yamlì„ í™•ì¸í•˜ì„¸ìš”.")
            # API í‚¤ê°€ ì—†ì–´ë„ ì´ˆê¸°í™”ëŠ” ì§„í–‰ (í…ŒìŠ¤íŠ¸ìš©)
        
        self.session = requests.Session()
        self.session.headers.update({
            'User-Agent': 'DART-API-Client/1.0',
            'Accept': 'application/json',
            'Content-Type': 'application/json'
        })
        
        self.last_request_time = 0
        self.request_interval = 0.1  # DART APIëŠ” ì´ˆë‹¹ 10íšŒ ì œí•œ
        
        logger.info(f"ğŸ” DART API ì´ˆê¸°í™” ì™„ë£Œ: {self.base_url}")
    
    def _load_config(self, config_path: str) -> Dict[str, Any]:
        """ì„¤ì • íŒŒì¼ ë¡œë“œ (ì¬ê·€ ì˜¤ë¥˜ ë°©ì§€)"""
        try:
            with open(config_path, 'r', encoding='utf-8') as f:
                config = yaml.safe_load(f)
                if config is None:
                    logger.warning("ì„¤ì • íŒŒì¼ì´ ë¹„ì–´ìˆìŠµë‹ˆë‹¤.")
                    return {}
                return config
        except yaml.YAMLError as e:
            logger.error(f"YAML íŒŒì‹± ì˜¤ë¥˜: {e}")
            return {}
        except FileNotFoundError:
            logger.error(f"ì„¤ì • íŒŒì¼ì„ ì°¾ì„ ìˆ˜ ì—†ìŠµë‹ˆë‹¤: {config_path}")
            return {}
        except Exception as e:
            logger.error(f"ì„¤ì • íŒŒì¼ ë¡œë“œ ì‹¤íŒ¨: {e}")
            return {}
    
    def _get_dart_api_key(self) -> Optional[str]:
        """DART API í‚¤ ì¶”ì¶œ (ì•ˆì „í•œ ë°©ì‹)"""
        try:
            if not self.config:
                return None
            
            # ì—¬ëŸ¬ ê²½ë¡œì—ì„œ API í‚¤ ì°¾ê¸°
            api_key = None
            
            # ê²½ë¡œ 1: api.dart.api_key
            if 'api' in self.config and 'dart' in self.config['api']:
                api_key = self.config['api']['dart'].get('api_key')
            
            # ê²½ë¡œ 2: ì§ì ‘ dart í‚¤
            if not api_key and 'dart' in self.config:
                api_key = self.config['dart'].get('api_key')
            
            return api_key
            
        except Exception as e:
            logger.error(f"DART API í‚¤ ì¶”ì¶œ ì‹¤íŒ¨: {e}")
            return None
    
    def _rate_limit(self):
        """API ìš”ì²­ ì†ë„ ì œì–´"""
        elapsed_time = time.time() - self.last_request_time
        if elapsed_time < self.request_interval:
            time.sleep(self.request_interval - elapsed_time)
        self.last_request_time = time.time()
    
    def _send_request(self, endpoint: str, params: Dict[str, Any]) -> Optional[Dict[str, Any]]:
        """DART API ìš”ì²­ ì „ì†¡"""
        self._rate_limit()
        
        url = f"{self.base_url}/{endpoint}"
        params['crtfc_key'] = self.api_key
        
        try:
            response = self.session.get(url, params=params, timeout=self.timeout)
            response.raise_for_status()
            
            # DART APIëŠ” XML ì‘ë‹µì„ ì£¼ë¡œ ì‚¬ìš©
            if response.headers.get('content-type', '').startswith('application/xml'):
                return self._parse_xml_response(response.text)
            else:
                return response.json()
                
        except requests.exceptions.RequestException as e:
            logger.error(f"DART API ìš”ì²­ ì‹¤íŒ¨: {e}")
            return None
        except Exception as e:
            logger.error(f"DART API ì‘ë‹µ ì²˜ë¦¬ ì‹¤íŒ¨: {e}")
            return None
    
    def _parse_xml_response(self, xml_text: str) -> Dict[str, Any]:
        """XML ì‘ë‹µ íŒŒì‹±"""
        try:
            root = ET.fromstring(xml_text)
            result = {}
            
            for child in root:
                if child.text:
                    result[child.tag] = child.text
                else:
                    result[child.tag] = self._parse_xml_response(ET.tostring(child, encoding='unicode'))
            
            return result
        except Exception as e:
            logger.error(f"XML íŒŒì‹± ì‹¤íŒ¨: {e}")
            return {}
    
    def get_corp_code_list(self) -> List[Dict[str, str]]:
        """ê¸°ì—… ê³ ìœ ë²ˆí˜¸ ëª©ë¡ ì¡°íšŒ"""
        logger.info("ğŸ” DARTì—ì„œ ê¸°ì—… ê³ ìœ ë²ˆí˜¸ ëª©ë¡ ì¡°íšŒ ì¤‘...")
        
        params = {}
        data = self._send_request("corpCode.xml", params)
        
        if not data:
            logger.error("ê¸°ì—… ê³ ìœ ë²ˆí˜¸ ëª©ë¡ ì¡°íšŒ ì‹¤íŒ¨")
            return []
        
        # XML ì‘ë‹µì—ì„œ ê¸°ì—… ì •ë³´ ì¶”ì¶œ
        corps = []
        try:
            root = ET.fromstring(data.get('response', ''))
            for corp in root.findall('list'):
                corp_info = {
                    'corp_code': corp.find('corp_code').text if corp.find('corp_code') is not None else '',
                    'corp_name': corp.find('corp_name').text if corp.find('corp_name') is not None else '',
                    'stock_code': corp.find('stock_code').text if corp.find('stock_code') is not None else '',
                    'modify_date': corp.find('modify_date').text if corp.find('modify_date') is not None else ''
                }
                # ì£¼ì‹ì½”ë“œê°€ ìˆëŠ” ê¸°ì—…ë§Œ í¬í•¨ (ìƒì¥ê¸°ì—…)
                if corp_info['stock_code'] and corp_info['stock_code'] != '':
                    corps.append(corp_info)
        except Exception as e:
            logger.error(f"ê¸°ì—… ê³ ìœ ë²ˆí˜¸ íŒŒì‹± ì‹¤íŒ¨: {e}")
            return []
        
        logger.info(f"âœ… {len(corps)}ê°œ ìƒì¥ê¸°ì—… ì •ë³´ ìˆ˜ì§‘ ì™„ë£Œ")
        return corps
    
    def get_financial_statements(self, corp_code: str, year: int = None, quarter: int = None) -> Optional[Dict[str, Any]]:
        """ì¬ë¬´ì œí‘œ ì¡°íšŒ"""
        if year is None:
            year = datetime.now().year - 1  # ì‘ë…„ ì—°ê°„ë³´ê³ ì„œ
        
        params = {
            'corp_code': corp_code,
            'bsns_year': str(year),
            'reprt_code': '11011'  # ì—°ê°„ë³´ê³ ì„œ
        }
        
        if quarter:
            params['reprt_code'] = f'1{quarter:02d}11'  # ë¶„ê¸°ë³´ê³ ì„œ
        
        data = self._send_request("fnlttSinglAcnt.json", params)
        
        if not data or data.get('status') != '000':
            logger.debug(f"ì¬ë¬´ì œí‘œ ì¡°íšŒ ì‹¤íŒ¨: {corp_code}")
            return None
        
        return data
    
    def get_share_capital_info(self, corp_code: str) -> Optional[Dict[str, Any]]:
        """ìë³¸ê¸ˆ ì •ë³´ ì¡°íšŒ"""
        params = {
            'corp_code': corp_code
        }
        
        data = self._send_request("fnlttSinglAcnt.json", params)
        
        if not data or data.get('status') != '000':
            return None
        
        # ìë³¸ê¸ˆ ê´€ë ¨ ì •ë³´ ì¶”ì¶œ
        capital_info = {}
        for item in data.get('list', []):
            if item.get('account_nm') in ['ìë³¸ê¸ˆ', 'ë‚©ì…ìë³¸ê¸ˆ', 'ë°œí–‰ì£¼ì‹ì´ìˆ˜']:
                capital_info[item.get('account_nm')] = {
                    'thstrm_amount': item.get('thstrm_amount', '0'),
                    'frmtrm_amount': item.get('frmtrm_amount', '0')
                }
        
        return capital_info
    
    def calculate_market_cap(self, stock_code: str, current_price: float) -> Optional[float]:
        """ì‹œê°€ì´ì•¡ ê³„ì‚°"""
        # ê¸°ì—… ê³ ìœ ë²ˆí˜¸ ì¡°íšŒ
        corps = self.get_corp_code_list()
        corp_code = None
        
        for corp in corps:
            if corp['stock_code'] == stock_code:
                corp_code = corp['corp_code']
                break
        
        if not corp_code:
            logger.debug(f"ê¸°ì—… ê³ ìœ ë²ˆí˜¸ë¥¼ ì°¾ì„ ìˆ˜ ì—†ìŒ: {stock_code}")
            return None
        
        # ìë³¸ê¸ˆ ì •ë³´ ì¡°íšŒ
        capital_info = self.get_share_capital_info(corp_code)
        if not capital_info:
            logger.debug(f"ìë³¸ê¸ˆ ì •ë³´ë¥¼ ì°¾ì„ ìˆ˜ ì—†ìŒ: {stock_code}")
            return None
        
        # ë°œí–‰ì£¼ì‹ìˆ˜ ì¶”ì¶œ
        issued_shares = None
        for account_name, info in capital_info.items():
            if 'ë°œí–‰ì£¼ì‹' in account_name or 'ìë³¸ê¸ˆ' in account_name:
                try:
                    # ìë³¸ê¸ˆì„ ì•¡ë©´ê°€ë¡œ ë‚˜ëˆ„ì–´ ë°œí–‰ì£¼ì‹ìˆ˜ ê³„ì‚°
                    capital = float(info['thstrm_amount'].replace(',', ''))
                    if capital > 0:
                        # ì¼ë°˜ì ì¸ ì•¡ë©´ê°€ 500ì› ê¸°ì¤€ìœ¼ë¡œ ê³„ì‚°
                        issued_shares = capital / 500
                        break
                except (ValueError, ZeroDivisionError):
                    continue
        
        if not issued_shares:
            logger.debug(f"ë°œí–‰ì£¼ì‹ìˆ˜ë¥¼ ê³„ì‚°í•  ìˆ˜ ì—†ìŒ: {stock_code}")
            return None
        
        # ì‹œê°€ì´ì•¡ ê³„ì‚°
        market_cap = issued_shares * current_price
        logger.debug(f"ì‹œê°€ì´ì•¡ ê³„ì‚°: {stock_code} = {issued_shares:,.0f}ì£¼ Ã— {current_price:,.0f}ì› = {market_cap:,.0f}ì›")
        
        return market_cap
    
    def get_top_stocks_by_market_cap(self, max_count: int = 250, current_prices: Dict[str, float] = None) -> List[Dict[str, Any]]:
        """ì‹œê°€ì´ì•¡ ìƒìœ„ ì¢…ëª© ì¡°íšŒ"""
        logger.info(f"ğŸ” DART APIë¡œ ì‹œê°€ì´ì•¡ ìƒìœ„ {max_count}ê°œ ì¢…ëª© ì¡°íšŒ ì‹œì‘")
        
        # ê¸°ì—… ê³ ìœ ë²ˆí˜¸ ëª©ë¡ ì¡°íšŒ
        corps = self.get_corp_code_list()
        if not corps:
            logger.error("ê¸°ì—… ê³ ìœ ë²ˆí˜¸ ëª©ë¡ ì¡°íšŒ ì‹¤íŒ¨")
            return []
        
        # KOSPI/KOSDAQ ì¢…ëª©ë§Œ í•„í„°ë§ (6ìë¦¬ ìˆ«ì ì½”ë“œ)
        listed_corps = []
        for corp in corps:
            stock_code = corp['stock_code']
            if stock_code and len(stock_code) == 6 and stock_code.isdigit():
                listed_corps.append(corp)
        
        logger.info(f"ğŸ” {len(listed_corps)}ê°œ ìƒì¥ì¢…ëª© ì¤‘ ì‹œê°€ì´ì•¡ ê³„ì‚° ì¤‘...")
        
        # ì‹œê°€ì´ì•¡ ê³„ì‚°
        market_caps = []
        successful_count = 0
        
        for i, corp in enumerate(listed_corps):
            if successful_count >= max_count * 2:  # ì—¬ìœ ë¶„ í™•ë³´
                break
            
            stock_code = corp['stock_code']
            corp_name = corp['corp_name']
            
            # í˜„ì¬ê°€ ì¡°íšŒ (KIS API ë˜ëŠ” ì™¸ë¶€ ì†ŒìŠ¤ ì‚¬ìš©)
            if current_prices and stock_code in current_prices:
                current_price = current_prices[stock_code]
            else:
                # ì—¬ê¸°ì„œëŠ” KIS APIë¥¼ ì‚¬ìš©í•˜ê±°ë‚˜ ê¸°ë³¸ê°’ ì‚¬ìš©
                current_price = 10000  # ê¸°ë³¸ê°’ (ì‹¤ì œë¡œëŠ” KIS APIì—ì„œ ì¡°íšŒ)
            
            # ì‹œê°€ì´ì•¡ ê³„ì‚°
            market_cap = self.calculate_market_cap(stock_code, current_price)
            
            if market_cap and market_cap > 0:
                market_caps.append({
                    'code': stock_code,
                    'name': corp_name,
                    'market_cap': market_cap,
                    'current_price': current_price,
                    'corp_code': corp['corp_code']
                })
                successful_count += 1
            
            # ì§„í–‰ë¥  í‘œì‹œ
            if (i + 1) % 100 == 0:
                logger.info(f"ğŸ” ì§„í–‰ë¥ : {i + 1}/{len(listed_corps)}, ì„±ê³µ: {successful_count}")
        
        # ì‹œê°€ì´ì•¡ ìˆœìœ¼ë¡œ ì •ë ¬
        market_caps.sort(key=lambda x: x['market_cap'], reverse=True)
        
        # ìƒìœ„ Nê°œ ë°˜í™˜
        top_stocks = market_caps[:max_count]
        
        logger.info(f"âœ… DART APIë¡œ ì‹œê°€ì´ì•¡ ìƒìœ„ {len(top_stocks)}ê°œ ì¢…ëª© ì¡°íšŒ ì™„ë£Œ")
        
        return top_stocks
    
    def get_financial_ratios(self, corp_code: str) -> Optional[Dict[str, float]]:
        """ì¬ë¬´ë¹„ìœ¨ ì¡°íšŒ"""
        # ì¬ë¬´ì œí‘œ ì¡°íšŒ
        financial_data = self.get_financial_statements(corp_code)
        if not financial_data:
            return None
        
        # ì¬ë¬´ë¹„ìœ¨ ê³„ì‚°
        ratios = {}
        
        # PER, PBR, ROE ë“± ê³„ì‚° ë¡œì§ êµ¬í˜„
        # ì‹¤ì œ êµ¬í˜„ì—ì„œëŠ” ì¬ë¬´ì œí‘œ ë°ì´í„°ë¥¼ íŒŒì‹±í•˜ì—¬ ê³„ì‚°
        
        return ratios

def main():
    """í…ŒìŠ¤íŠ¸ í•¨ìˆ˜"""
    try:
        dart_provider = DartDataProvider()
        
        # ê¸°ì—… ê³ ìœ ë²ˆí˜¸ ëª©ë¡ ì¡°íšŒ í…ŒìŠ¤íŠ¸
        corps = dart_provider.get_corp_code_list()
        print(f"ìƒì¥ê¸°ì—… ìˆ˜: {len(corps)}")
        
        # ìƒìœ„ 10ê°œ ì¢…ëª© ì¡°íšŒ í…ŒìŠ¤íŠ¸
        top_stocks = dart_provider.get_top_stocks_by_market_cap(10)
        print(f"ìƒìœ„ 10ê°œ ì¢…ëª©:")
        for stock in top_stocks:
            print(f"  {stock['code']}: {stock['name']} - {stock['market_cap']:,.0f}ì›")
            
    except Exception as e:
        logger.error(f"DART API í…ŒìŠ¤íŠ¸ ì‹¤íŒ¨: {e}")

if __name__ == "__main__":
    main()
