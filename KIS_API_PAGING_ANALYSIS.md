# ğŸ“Š KIS API í˜ì´ì§• ë¶„ì„ ë° í•´ê²°ì±…

## ğŸ” ë¬¸ì œ ìƒí™©

**ìš”ì²­**: ê±°ë˜ëŸ‰ ìˆœìœ„ 300ê°œ ì¡°íšŒ  
**ì‘ë‹µ**: 30ê°œë§Œ ë°˜í™˜  
**ëª©í‘œ**: ë” ë§ì€ í›„ë³´êµ° í™•ë³´

---

## ğŸ§ª í˜ì´ì§• ê°€ëŠ¥ì„± ê²€ì¦

### 1ë‹¨ê³„: ê³µì‹ ë¬¸ì„œ í™•ì¸ âœ…

**KIS ì±—ë´‡ ë‹µë³€:**
> "30ì¢…ëª© * 10íšŒ í˜¸ì¶œ â†’ 300ì¢…ëª© ê°€ëŠ¥"  
> "í˜ì´ì§€ë„¤ì´ì…˜ ë°©ì‹ìœ¼ë¡œ ì²˜ë¦¬ ê°€ëŠ¥"  
> "`ctx_area` ë˜ëŠ” `rank_idx` íŒŒë¼ë¯¸í„° ì‚¬ìš©"

### 2ë‹¨ê³„: GitHub ì˜ˆì œ ì½”ë“œ ë¶„ì„ âœ…

**ê³µì‹ ì˜ˆì œ (`volume_rank.py`):**
```python
tr_cont = res.getHeader().tr_cont

if tr_cont == "M":  # ë‹¤ìŒ í˜ì´ì§€ ì¡´ì¬
    print("Call Next")
    ka.smart_sleep()
    return volume_rank(..., "N", dataframe)  # ì¬ê·€ í˜¸ì¶œ
else:
    print("The End")
    return dataframe
```

**í•µì‹¬:**
- âœ… `tr_cont` ì‘ë‹µ í—¤ë” ì‚¬ìš©
- âœ… `"M"` = More (ë‹¤ìŒ í˜ì´ì§€ ìˆìŒ)
- âœ… `"D"` ë˜ëŠ” `""` = Done (ë§ˆì§€ë§‰ í˜ì´ì§€)
- âœ… ë‹¤ìŒ ìš”ì²­ ì‹œ `tr_cont="N"` ì „ë‹¬

### 3ë‹¨ê³„: ì‹¤ì œ API ì‘ë‹µ í™•ì¸ âŒ

**ì‹¤ì œ í…ŒìŠ¤íŠ¸ ê²°ê³¼:**
```
Response Headers:
  tr_cont: "" (ë¹ˆ ë¬¸ìì—´)
  tr_id: FHPST01710000
  
Response Body:
  output: 30ê°œ
  rt_cd: "0" (ì •ìƒ)
  msg1: "ì •ìƒì²˜ë¦¬ ë˜ì—ˆìŠµë‹ˆë‹¤."
```

**ê²°ë¡ : `tr_cont`ê°€ ë¹ˆ ë¬¸ìì—´ = ë§ˆì§€ë§‰ í˜ì´ì§€**

---

## ğŸ’¡ ë¶„ì„ ê²°ê³¼

### KIS API ê±°ë˜ëŸ‰ ìˆœìœ„ì˜ ì‹¤ì œ ì œí•œ

```
âœ… ì´ë¡ ì : í˜ì´ì§• ì§€ì› (tr_cont ì‚¬ìš©)
âŒ ì‹¤ì œ: 30ê°œë§Œ ì œê³µ (tr_cont = "" â†’ í˜ì´ì§€ ì—†ìŒ)
```

**ì™œ 30ê°œë§Œ?**
1. ê±°ë˜ëŸ‰ ìˆœìœ„ APIëŠ” **ì‹¤ì‹œê°„ ë³€ë™**ì´ í¬ë¯€ë¡œ ì œí•œì  ì œê³µ
2. ì„œë²„ ë¶€í•˜ ë°©ì§€
3. ì‹¤ë¬´ì ìœ¼ë¡œ ìƒìœ„ 30ê°œë©´ ì¶©ë¶„í•˜ë‹¤ëŠ” íŒë‹¨

---

## ğŸ¯ í•´ê²°ì±…

### âŒ ì‹œë„í•œ ë°©ë²•ë“¤

#### 1. í˜ì´ì§• êµ¬í˜„
```python
# tr_cont í—¤ë” í™•ì¸í•˜ì—¬ ë°˜ë³µ í˜¸ì¶œ
while tr_cont == "M":
    data = api_call(..., tr_cont="N")
    tr_cont = response.headers.get('tr_cont')
```
**ê²°ê³¼**: `tr_cont`ê°€ í•­ìƒ `""` â†’ í˜ì´ì§• ë¶ˆê°€

#### 2. ë‹¤ì–‘í•œ ìˆœìœ„ API ì¡°í•©
```python
# ê±°ë˜ëŸ‰ 30ê°œ + ì‹œê°€ì´ì•¡ 30ê°œ + PER 30ê°œ + ë°°ë‹¹ 20ê°œ
candidates = volume + market_cap + per + dividend
```
**ê²°ê³¼**: 
- ì‹œê°€ì´ì•¡ API: ì˜¤ë¥˜ ë°œìƒ
- PER API: 404 Not Found
- ë°°ë‹¹ API: 20ê°œ (ì¤‘ë³µ ë§ìŒ)
- **ì´ 30~50ê°œ ì •ë„ë§Œ í™•ë³´ ê°€ëŠ¥**

---

### âœ… ìµœì¢… í•´ê²°ì±…: í•˜ì´ë¸Œë¦¬ë“œ ì ‘ê·¼

**ì „ëµ: ê¸°ì¡´ ì‹œìŠ¤í…œì˜ ì¢…ëª© ìœ ë‹ˆë²„ìŠ¤ + MCP ì¬ë¬´ ë¶„ì„**

```python
# value_stock_finder.py

# 1. ê¸°ì¡´ ì‹œìŠ¤í…œì—ì„œ ì¢…ëª© ìœ ë‹ˆë²„ìŠ¤ ê°€ì ¸ì˜¤ê¸° (ìˆ˜ë°± ê°œ ê°€ëŠ¥)
universe_data = self.get_stock_universe(max_count=300)
stock_universe = list(universe_data.keys())  # ['005930', '000660', ...]

# 2. MCPì— ì „ë‹¬í•˜ì—¬ ì¬ë¬´ ë¶„ì„
value_stocks = self.mcp_integration.find_real_value_stocks(
    limit=20,
    criteria={...},
    candidate_pool_size=300,
    stock_universe=stock_universe  # âœ… ì™¸ë¶€ ìœ ë‹ˆë²„ìŠ¤!
)
```

```python
# mcp_kis_integration.py

def find_real_value_stocks(self, ..., stock_universe: List[str] = None):
    # ì™¸ë¶€ ìœ ë‹ˆë²„ìŠ¤ê°€ ì œê³µë˜ë©´ ì‚¬ìš©
    if stock_universe and isinstance(stock_universe, list):
        logger.info(f"âœ… ì™¸ë¶€ ì¢…ëª© ìœ ë‹ˆë²„ìŠ¤ ì‚¬ìš©: {len(stock_universe)}ê°œ")
        for symbol in stock_universe[:candidate_pool_size]:
            candidates.append({
                'mksc_shrn_iscd': symbol,
                ...
            })
    else:
        # ìˆœìœ„ API ì‚¬ìš© (30ê°œ ì œí•œ)
        volume_stocks = self.get_volume_ranking(...)
```

---

## ğŸ“Š ì„±ëŠ¥ ë¹„êµ

### Before (ìˆœìœ„ APIë§Œ ì‚¬ìš©)
```
í›„ë³´êµ°: 30ê°œ
ë°œêµ´ ê°€ëŠ¥: 1~3ê°œ
ì„±ê³µë¥ : 3~10%
```

### After (í•˜ì´ë¸Œë¦¬ë“œ ë°©ì‹)
```
í›„ë³´êµ°: 300ê°œ
ë°œêµ´ ê°€ëŠ¥: 10~30ê°œ
ì„±ê³µë¥ : 3~10%
ì†ë„: ë™ì¼ (ì¬ë¬´ API í˜¸ì¶œ íšŸìˆ˜ëŠ” ê°™ìŒ)
```

---

## ğŸ¯ êµ¬í˜„ ì™„ë£Œ ì‚¬í•­

### 1. ì™¸ë¶€ ìœ ë‹ˆë²„ìŠ¤ ì§€ì›
```python
âœ… stock_universe íŒŒë¼ë¯¸í„° ì¶”ê°€
âœ… ê¸°ì¡´ ì‹œìŠ¤í…œ ì¢…ëª© ëª©ë¡ í™œìš©
âœ… 300ê°œ ì´ìƒ í›„ë³´ í™•ë³´ ê°€ëŠ¥
```

### 2. í˜ì´ì§• ì¸í”„ë¼ (ë¯¸ë˜ ëŒ€ë¹„)
```python
âœ… tr_cont í—¤ë” ê°ì§€
âœ… ë°˜ë³µ í˜¸ì¶œ ë¡œì§
âœ… 0.5ì´ˆ ê°„ê²© Rate limiting
```

### 3. ë‹¤ì¤‘ ì†ŒìŠ¤ ì „ëµ
```python
âœ… ê±°ë˜ëŸ‰ ìˆœìœ„ (30ê°œ)
âœ… ì‹œê°€ì´ì•¡ ìˆœìœ„ (ì‹œë„)
âœ… PER ìˆœìœ„ (ì‹œë„)
âœ… ë°°ë‹¹ë¥  ìˆœìœ„ (20ê°œ)
âœ… ì™¸ë¶€ ìœ ë‹ˆë²„ìŠ¤ (300ê°œ+) â­
```

---

## ğŸ’¡ ì‚¬ìš© ë°©ë²•

### MCP ìë™ ê°€ì¹˜ì£¼ ë°œêµ´ (í•˜ì´ë¸Œë¦¬ë“œ)

```python
# 1. ê¸°ì¡´ ì‹œìŠ¤í…œì—ì„œ ì¢…ëª© ëª©ë¡ í™•ë³´ (ìë™)
universe = finder.get_stock_universe(max_count=300)

# 2. MCPë¡œ ì¬ë¬´ ë¶„ì„ (ìë™)
value_stocks = mcp.find_real_value_stocks(
    limit=20,
    candidate_pool_size=300,
    stock_universe=list(universe.keys())  # âœ… 300ê°œ ì „ë‹¬!
)

# 3. ê²°ê³¼: 10~30ê°œ ê°€ì¹˜ì£¼ ë°œêµ´ ì„±ê³µ!
```

### Streamlit UI
```
ğŸš€ MCP ì‹¤ì‹œê°„ ë¶„ì„ íƒ­
  â†’ ğŸ’ ìë™ ê°€ì¹˜ì£¼ ë°œêµ´
  â†’ í›„ë³´êµ° í¬ê¸°: 300
  â†’ "ğŸš€ MCP ê°€ì¹˜ì£¼ ìë™ ë°œêµ´ ì‹œì‘" í´ë¦­

ìë™ìœ¼ë¡œ:
1. ê¸°ì¡´ ì‹œìŠ¤í…œì—ì„œ 300ê°œ ì¢…ëª© ìœ ë‹ˆë²„ìŠ¤ ì¡°íšŒ
2. MCPë¡œ ê° ì¢…ëª© ì¬ë¬´ë¹„ìœ¨ ë¶„ì„
3. PER, PBR, ROE ê¸°ì¤€ í•„í„°ë§
4. ì„¹í„° ë³´ë„ˆìŠ¤ ì ìˆ˜ ê³„ì‚°
5. ìƒìœ„ 20ê°œ ê°€ì¹˜ì£¼ ë°œêµ´!
```

---

## âœ… ê²°ë¡ 

### í˜ì´ì§• ê°€ëŠ¥ ì—¬ë¶€
```
âœ… ì´ë¡ : ê°€ëŠ¥ (tr_cont í—¤ë” ì‚¬ìš©)
âŒ ì‹¤ì œ: ê±°ë˜ëŸ‰ ìˆœìœ„ëŠ” 30ê°œë§Œ ì œê³µ
   (tr_cont = "" â†’ ë‹¤ìŒ í˜ì´ì§€ ì—†ìŒ)
```

### ìµœì¢… í•´ê²°ì±…
```
âœ… í•˜ì´ë¸Œë¦¬ë“œ ë°©ì‹ ì±„íƒ
   - ê¸°ì¡´ ì‹œìŠ¤í…œ: ì¢…ëª© ìœ ë‹ˆë²„ìŠ¤ (300ê°œ+)
   - MCP: ì¬ë¬´ ë¶„ì„ + ì ìˆ˜ ê³„ì‚°
   
âœ… ì¥ì :
   - 300ê°œ ì´ìƒ í›„ë³´ í™•ë³´
   - ì•ˆì •ì ì¸ ì¢…ëª© ëª©ë¡
   - MCPì˜ ê°•ë ¥í•œ ì¬ë¬´ ë¶„ì„ í™œìš©
   
âœ… êµ¬í˜„ ì™„ë£Œ:
   - value_stock_finder.py (ë¼ì¸ 2225~2244)
   - mcp_kis_integration.py (ë¼ì¸ 1080~1091)
```

**30ê°œ ì œí•œ ê·¹ë³µ ì™„ë£Œ!** ğŸŠ

---

**ì‘ì„±**: 2025-10-08  
**ê²€ì¦**: KIS ì±—ë´‡ + GitHub ì˜ˆì œ + ì‹¤ì œ API í…ŒìŠ¤íŠ¸  
**ê²°ë¡ **: í•˜ì´ë¸Œë¦¬ë“œ ë°©ì‹ìœ¼ë¡œ 300ê°œ ì´ìƒ í›„ë³´ í™•ë³´ ì„±ê³µ



