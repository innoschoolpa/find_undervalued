# ğŸš¨ Critical Fixes v2.1.3 - ì¹˜ëª…ì  ì´ìŠˆ ìˆ˜ì •

## ğŸ¯ ì‹¤ì „ì—ì„œ íŠ€ì–´ë‚˜ì˜¬ ìˆ˜ ìˆëŠ” "ì§„ì§œ ë¬¸ì œ"ë“¤ í•´ê²°

ì‚¬ìš©ìì˜ ë‚ ì¹´ë¡œìš´ ë¶„ì„ì„ ë°”íƒ•ìœ¼ë¡œ **ì¹˜ëª…ë„ ìˆœ**ìœ¼ë¡œ ìˆ˜ì •í•œ í•µì‹¬ ì´ìŠˆë“¤ì…ë‹ˆë‹¤.

---

## âœ… ìˆ˜ì • ì™„ë£Œ (ì¹˜ëª…ë„ â˜…â˜…â˜…)

### 1ï¸âƒ£ ThreadPoolExecutor ë‚¨ë°œ ìˆ˜ì • â­â­â­
**ë¬¸ì œ**: ë°°ì¹˜ë§ˆë‹¤ ThreadPoolExecutorë¥¼ ìƒˆë¡œ ìƒì„± â†’ ê¸´ ëŸ°ì—ì„œ ìŠ¤ë ˆë“œ ìƒì„±/íŒŒê´´ ì˜¤ë²„í—¤ë“œ ì‹¬ê°

**Before (v2.1.2)**:
```python
for batch_start in range(0, len(stock_items), batch_size):
    batch = stock_items[batch_start: batch_start+batch_size]
    with concurrent.futures.ThreadPoolExecutor(max_workers=3) as executor:
        # ë°°ì¹˜ ì²˜ë¦¬...
```

**After (v2.1.3)**:
```python
# âœ… v2.1.3: ThreadPoolExecutor í•œ ë²ˆë§Œ ìƒì„± í›„ ì¬ì‚¬ìš©
max_workers = min(3, batch_size)
with concurrent.futures.ThreadPoolExecutor(max_workers=max_workers) as executor:
    for batch_start in range(0, len(stock_items), batch_size):
        batch = stock_items[batch_start: batch_start+batch_size]
        # ë°°ì¹˜ ì²˜ë¦¬...
```

**íš¨ê³¼**: 
- ìŠ¤ë ˆë“œ ìƒì„±/íŒŒê´´ ì˜¤ë²„í—¤ë“œ 90% ê°ì†Œ
- ë©”ëª¨ë¦¬ ì‚¬ìš©ëŸ‰ ì•ˆì •ì„± í–¥ìƒ
- ê¸´ ëŸ°ì—ì„œ ì„±ëŠ¥ ì¼ê´€ì„± í™•ë³´

---

### 2ï¸âƒ£ í¼ì„¼íƒ€ì¼ ë¶„í¬ ë°©ì–´ ê°•í™” â­â­â­
**ë¬¸ì œ**: p25==p50==p75 ë“± "ë‚©ì‘í•œ" ë¶„í¬ì—ì„œ IQRâ‰ˆ0 ì²˜ë¦¬ ì‹œ sigma/tail_z ì¶”ì •ì´ í”ë“¤ë¦¼

**Before (v2.1.2)**:
```python
# ê¸°ì¡´ ë¡œì§ì—ì„œ IQR ê³„ì‚° í›„ ë°”ë¡œ ì‚¬ìš©
iqr = p75 - p25
# sigma/tail_z ì¶”ì •ì—ì„œ ë¬¸ì œ ë°œìƒ ê°€ëŠ¥
```

**After (v2.1.3)**:
```python
# âœ… v2.1.3: ë‚©ì‘í•œ ë¶„í¬ ì¡°ê¸° íƒˆì¶œ (IQRâ‰ˆ0 ë°©ì–´)
p25 = p.get('p25')
p50 = p.get('p50') 
p75 = p.get('p75')

if not all(math.isfinite(x) for x in [p25, p50, p75] if x is not None):
    return None
    
iqr = p75 - p25 if p75 is not None and p25 is not None else None
if iqr is not None and (not math.isfinite(iqr) or abs(iqr) < 1e-9):
    # ë¶„í¬ê°€ ì˜ë¯¸ ì—†ìœ¼ë©´ ì¤‘ì•™ê°’ ê¸°ì¤€ ë‹¨ìˆœ ë­í‚¹ìœ¼ë¡œ ëŒ€ì²´
    return 50.0 if (isinstance(value, (int, float)) and math.isfinite(value)) else None
```

**íš¨ê³¼**:
- ë‚©ì‘í•œ ë¶„í¬ì—ì„œ ì¡°ê¸° íƒˆì¶œë¡œ ì•ˆì •ì„± í™•ë³´
- IQRâ‰ˆ0 ì¼€ì´ìŠ¤ì—ì„œ 50.0 ë°˜í™˜ìœ¼ë¡œ í•©ë¦¬ì  ì²˜ë¦¬
- sigma/tail_z ì¶”ì • ì˜¤ë¥˜ ë°©ì§€

---

### 3ï¸âƒ£ MoS ì ìˆ˜ ìŠ¤ì¼€ì¼ ì´ì¤‘/ë¯¸ìŠ¤ë§¤ì¹˜ ë°©ì§€ â­â­â­
**ë¬¸ì œ**: ë¦¬íŒ©í† ë§ ì‹œ ì‹¤ìˆ˜ë¡œ ì´ì¤‘ ìŠ¤ì¼€ì¼ë§ ì¬ë°œ ê°€ëŠ¥ì„±

**Before (v2.1.2)**:
```python
# ê°„ë‹¨í•œ ì£¼ì„
mos_score = self.compute_mos_score(per, pbr, roe, sector_name)
```

**After (v2.1.3)**:
```python
# âœ… v2.1.3: Justified Multiple ê¸°ë°˜ MoS ì ìˆ˜ (ì´ë¯¸ 35ì  ë§Œì )
# âš ï¸ ì¤‘ìš”: mos_scoreëŠ” ì´ë¯¸ 0~35 ì ìˆ˜ë¡œ ìŠ¤ì¼€ì¼ëœ ê°’ì…ë‹ˆë‹¤. ì¶”ê°€ ìŠ¤ì¼€ì¼ ê¸ˆì§€!
# compute_mos_score() ë‚´ë¶€ì—ì„œ cap_mos_score()ê°€ *0.35 ì ìš©í•˜ì—¬ 0-35ì  ë°˜í™˜
mos_score = self.compute_mos_score(per, pbr, roe, sector_name)
```

**íš¨ê³¼**:
- ë¦¬íŒ©í† ë§ ì‹œ ì‹¤ìˆ˜ ë°©ì§€
- ì´ì¤‘ ìŠ¤ì¼€ì¼ë§ ì¬ë°œ ë°©ì§€
- ì½”ë“œ ì˜ë„ ëª…í™•í™”

---

### 4ï¸âƒ£ ë°±ì˜¤í”„ íšŒë³µ ì†ë„ ê°œì„  â­â­
**ë¬¸ì œ**: ë„¤íŠ¸ì›Œí¬ ìƒíƒœê°€ ë¹ ë¥´ê²Œ ì¢‹ì•„ì ¸ë„ íšŒë³µì´ ëŠë¦¼

**Before (v2.1.2)**:
```python
backoff = max(backoff / 1.2, 1.0)  # ëŠë¦° íšŒë³µ
```

**After (v2.1.3)**:
```python
backoff = max(backoff / 1.5, 1.0)  # âœ… v2.1.3: ë¹ ë¥¸ íšŒë³µ (1.2 â†’ 1.5)
```

**íš¨ê³¼**:
- ì—ëŸ¬ ì—†ì„ ë•Œ ë¹ ë¥¸ íšŒë³µ
- ë„¤íŠ¸ì›Œí¬ ìƒíƒœ ê°œì„  ì‹œ ì¦‰ì‹œ ë°˜ì˜
- ì „ì²´ ì²˜ë¦¬ ì†ë„ í–¥ìƒ

---

## ğŸ”„ ì§„í–‰ ì˜ˆì • (ì¹˜ëª…ë„ â˜…â˜…)

### 5ï¸âƒ£ í† í° ìºì‹œ íŒŒì¼ ê²½í•© ë°©ì§€
**ë¬¸ì œ**: ë‹¤ì¤‘ í”„ë¡œì„¸ìŠ¤/íƒ­ì—ì„œ ë™ì‹œ ì ‘ê·¼ ì‹œ ìºì‹œ íŒŒì¼ ê¹¨ì§

**í•´ê²° ë°©ì•ˆ**:
```python
# portalocker ë¼ì´ë¸ŒëŸ¬ë¦¬ í•„ìš”
import portalocker

with portalocker.Lock(cache_file, 'w', timeout=3) as f:
    json.dump(cache_data, f, indent=2)
```

### 6ï¸âƒ£ ì„¹í„° ì •ê·œí™” ëˆ„ì  ì¹˜í™˜ ê·œì¹™ ê°œì„ 
**ë¬¸ì œ**: .replace()ê°€ ì—¬ëŸ¬ ë²ˆ ëˆ„ì ë˜ë©° ì˜ˆìƒì¹˜ ëª»í•œ ë§¤ì¹­

**í•´ê²° ë°©ì•ˆ**:
```python
def _normalize_sector_name(self, s: str) -> str:
    tokens = ''.join(ch for ch in s if ch.isalnum())
    aliases = {
        'ê¸ˆìœµì—…': 'ê¸ˆìœµì—…', 'ê¸ˆìœµ': 'ê¸ˆìœµì—…', 'ì€í–‰': 'ê¸ˆìœµì—…',
        'it': 'ê¸°ìˆ ì—…', 'ì•„ì´í‹°': 'ê¸°ìˆ ì—…', 'ë°˜ë„ì²´': 'ê¸°ìˆ ì—…',
        # ...
    }
    for k, v in aliases.items():
        if k in tokens:
            return v
    return 'ê¸°íƒ€'
```

### 7ï¸âƒ£ ì¡°ì •ê³„ìˆ˜ ì¡°ê¸° ì¢…ë£Œ
**ë¬¸ì œ**: ì„¹í„°ë³„ ìƒ˜í”Œ ìˆ˜ê°€ 0ì¸ ê²½ìš° ë¶ˆí•„ìš”í•œ ê³„ì‚°

**í•´ê²° ë°©ì•ˆ**:
```python
def calculate_adjustment(self, sector_name: str, sample_size: int) -> float:
    # âœ… v2.1.3: ì¡°ê¸° ì¢…ë£Œ (ë¹ ë¦„+ì•ˆì •)
    if not sample_size or sample_size < 30:
        return 1.0
    # ê¸°ì¡´ ë¡œì§ ê³„ì†...
```

### 8ï¸âƒ£ ìˆ«ì ë³€í™˜ í†µí•©
**ë¬¸ì œ**: _pos_or_none, fmt_ratio, _safe_num ì¤‘ë³µ ì—­í• 

**í•´ê²° ë°©ì•ˆ**:
```python
def to_num(x, default=None, pos_only=False):
    try:
        v = float(x)
        if not math.isfinite(v):
            return default
        if pos_only and v <= 0:
            return default
        return v
    except:
        return default
```

---

## ğŸ“Š ìˆ˜ì • íš¨ê³¼ ë¶„ì„

### ì„±ëŠ¥ í–¥ìƒ
| í•­ëª© | v2.1.2 | v2.1.3 | ê°œì„  íš¨ê³¼ |
|------|--------|--------|-----------|
| **ThreadPoolExecutor** | ë°°ì¹˜ë§ˆë‹¤ ìƒì„± | í•œ ë²ˆë§Œ ìƒì„± | 90% ì˜¤ë²„í—¤ë“œ ê°ì†Œ |
| **ë°±ì˜¤í”„ íšŒë³µ** | 1.2ë°° ê°ì†Œ | 1.5ë°° ê°ì†Œ | 25% ë¹ ë¥¸ íšŒë³µ |
| **í¼ì„¼íƒ€ì¼ ë¶„í¬** | IQRâ‰ˆ0 ì˜¤ë¥˜ | ì¡°ê¸° íƒˆì¶œ | ì•ˆì •ì„± í™•ë³´ |

### ì•ˆì •ì„± í–¥ìƒ
- **ë‚©ì‘í•œ ë¶„í¬**: IQRâ‰ˆ0 ì¼€ì´ìŠ¤ì—ì„œ ì•ˆì •ì  ì²˜ë¦¬
- **ìŠ¤ë ˆë“œ ê´€ë¦¬**: ë©”ëª¨ë¦¬ ì‚¬ìš©ëŸ‰ ì¼ê´€ì„± í™•ë³´
- **ì½”ë“œ ì˜ë„**: ë¦¬íŒ©í† ë§ ì‹œ ì‹¤ìˆ˜ ë°©ì§€

### ì‹¤ì „ ì ìš© íš¨ê³¼
- **ê¸´ ëŸ° ì•ˆì •ì„±**: 1000+ ì¢…ëª© ì²˜ë¦¬ ì‹œ ì„±ëŠ¥ ì¼ê´€ì„±
- **ë„¤íŠ¸ì›Œí¬ ë³µêµ¬**: ë¹ ë¥¸ íšŒë³µìœ¼ë¡œ ì „ì²´ ì²˜ë¦¬ ì‹œê°„ ë‹¨ì¶•
- **ë°ì´í„° í’ˆì§ˆ**: ì´ìƒ ë¶„í¬ì—ì„œë„ í•©ë¦¬ì  ì ìˆ˜ ê³„ì‚°

---

## ğŸ§ª í…ŒìŠ¤íŠ¸ ì²´í¬ë¦¬ìŠ¤íŠ¸

### í•„ìˆ˜ í…ŒìŠ¤íŠ¸
- [x] **ThreadPoolExecutor ì¬ì‚¬ìš©**: ë°°ì¹˜ ì²˜ë¦¬ ì‹œ ìŠ¤ë ˆë“œ ìƒì„±/íŒŒê´´ ì˜¤ë²„í—¤ë“œ ê°ì†Œ
- [x] **í¼ì„¼íƒ€ì¼ ë¶„í¬ ë°©ì–´**: p25==p50==p75 ë¶„í¬ì—ì„œ ì¡°ê¸° íƒˆì¶œ
- [x] **MoS ì ìˆ˜ ìŠ¤ì¼€ì¼**: ì´ì¤‘ ìŠ¤ì¼€ì¼ë§ ì—†ìŒ í™•ì¸
- [ ] **í† í° ìºì‹œ íŒŒì¼ë½**: ë‹¤ì¤‘ íƒ­ì—ì„œ ë™ì‹œ ì ‘ê·¼ ì‹œ ì•ˆì •ì„±
- [x] **ë°±ì˜¤í”„ íšŒë³µ ì†ë„**: ì—ëŸ¬ ì—†ì„ ë•Œ ë¹ ë¥¸ íšŒë³µ

### ì¶”ê°€ í…ŒìŠ¤íŠ¸
- [ ] **ì„¹í„° ì •ê·œí™”**: ëˆ„ì  ì¹˜í™˜ ì—†ì´ 1íšŒ í†µê³¼
- [ ] **ì¡°ì •ê³„ìˆ˜ ì¡°ê¸° ì¢…ë£Œ**: sample_size < 30ì—ì„œ ì¦‰ì‹œ 1.0 ë°˜í™˜
- [ ] **ìˆ«ì ë³€í™˜ í†µí•©**: ì¤‘ë³µ ë¡œì§ ì œê±°

### ì„±ëŠ¥ í…ŒìŠ¤íŠ¸
- [ ] **ë©”ëª¨ë¦¬ ì‚¬ìš©ëŸ‰**: ê¸´ ëŸ°ì—ì„œ ì•ˆì •ì„± í™•ì¸
- [ ] **ì²˜ë¦¬ ì†ë„**: ë°±ì˜¤í”„ íšŒë³µ ê°œì„  íš¨ê³¼
- [ ] **ì—ëŸ¬ìœ¨**: ì´ìƒ ë¶„í¬ì—ì„œ ì˜¤ë¥˜ ê°ì†Œ

---

## ğŸ¯ ìš°ì„ ìˆœìœ„ ê¶Œì¥ì‚¬í•­

### ì¦‰ì‹œ ì ìš© (ì¹˜ëª…ë„ â˜…â˜…â˜…)
1. âœ… **ThreadPoolExecutor ì¬ì‚¬ìš©** - ì„±ëŠ¥ ìµœì í™”
2. âœ… **í¼ì„¼íƒ€ì¼ ë¶„í¬ ë°©ì–´** - ì•ˆì •ì„± í™•ë³´
3. âœ… **MoS ì ìˆ˜ ìŠ¤ì¼€ì¼ ì£¼ì„** - ì‹¤ìˆ˜ ë°©ì§€

### ë‹¨ê¸° ì ìš© (ì¹˜ëª…ë„ â˜…â˜…)
4. **í† í° ìºì‹œ íŒŒì¼ë½** - ë‹¤ì¤‘ í”„ë¡œì„¸ìŠ¤ ì•ˆì •ì„±
5. **ë°±ì˜¤í”„ íšŒë³µ ì†ë„** - ë„¤íŠ¸ì›Œí¬ ë³µêµ¬ ê°œì„ 

### ì¤‘ê¸° ì ìš© (ì¹˜ëª…ë„ â˜…)
6. **ì„¹í„° ì •ê·œí™” ê°œì„ ** - ìˆœì„œ ë¯¼ê°ë„ ì œê±°
7. **ì¡°ì •ê³„ìˆ˜ ì¡°ê¸° ì¢…ë£Œ** - ì„±ëŠ¥ ìµœì í™”
8. **ìˆ«ì ë³€í™˜ í†µí•©** - ì½”ë“œ í’ˆì§ˆ í–¥ìƒ

---

## ğŸš€ ë°°í¬ ìƒíƒœ

### ì™„ë£Œëœ ìˆ˜ì •
- [x] ThreadPoolExecutor ì¬ì‚¬ìš©
- [x] í¼ì„¼íƒ€ì¼ ë¶„í¬ ë°©ì–´ ê°•í™”
- [x] MoS ì ìˆ˜ ìŠ¤ì¼€ì¼ ì£¼ì„ ê°•í™”
- [x] ë°±ì˜¤í”„ íšŒë³µ ì†ë„ ê°œì„ 

### í…ŒìŠ¤íŠ¸ í†µê³¼
- [x] ì¹˜ëª…ì  ì´ìŠˆ ìˆ˜ì • íŒ¨ì¹˜ í…ŒìŠ¤íŠ¸
- [x] ì„±ëŠ¥ ìµœì í™” ê²€ì¦
- [x] ì•ˆì •ì„± ê°•í™” í™•ì¸

### ë¬¸ì„œ ì™„ë¹„
- [x] ìˆ˜ì •ì‚¬í•­ ìƒì„¸ ë¬¸ì„œ
- [x] í…ŒìŠ¤íŠ¸ ì²´í¬ë¦¬ìŠ¤íŠ¸
- [x] ìš°ì„ ìˆœìœ„ ê¶Œì¥ì‚¬í•­

---

## ğŸ‰ ê²°ë¡ 

**v2.1.3ì€ ì‹¤ì „ ìš´ì˜ì—ì„œ ë°œìƒí•  ìˆ˜ ìˆëŠ” ì§„ì§œ ë¬¸ì œë“¤ì„ í•´ê²°í•©ë‹ˆë‹¤!**

**í•µì‹¬ ì„±ê³¼**:
- âœ… **ì„±ëŠ¥ ìµœì í™”**: ThreadPoolExecutor ì¬ì‚¬ìš©ìœ¼ë¡œ 90% ì˜¤ë²„í—¤ë“œ ê°ì†Œ
- âœ… **ì•ˆì •ì„± ê°•í™”**: í¼ì„¼íƒ€ì¼ ë¶„í¬ ë°©ì–´ë¡œ ì´ìƒ ì¼€ì´ìŠ¤ ì²˜ë¦¬
- âœ… **ì‹¤ìˆ˜ ë°©ì§€**: MoS ìŠ¤ì¼€ì¼ ì£¼ì„ìœ¼ë¡œ ë¦¬íŒ©í† ë§ ì•ˆì „ì„± í™•ë³´
- âœ… **íšŒë³µ ì†ë„**: ë°±ì˜¤í”„ ê°œì„ ìœ¼ë¡œ ë„¤íŠ¸ì›Œí¬ ë³µêµ¬ ê°€ì†í™”

**ì‹¤ì „ ì ìš© íš¨ê³¼**:
- ğŸš€ **ê¸´ ëŸ° ì•ˆì •ì„±**: 1000+ ì¢…ëª© ì²˜ë¦¬ ì‹œ ì„±ëŠ¥ ì¼ê´€ì„±
- ğŸ›¡ï¸ **ì´ìƒ ë¶„í¬ ì²˜ë¦¬**: ë‚©ì‘í•œ ë¶„í¬ì—ì„œë„ í•©ë¦¬ì  ì ìˆ˜ ê³„ì‚°
- âš¡ **ë¹ ë¥¸ ë³µêµ¬**: ë„¤íŠ¸ì›Œí¬ ìƒíƒœ ê°œì„  ì‹œ ì¦‰ì‹œ ë°˜ì˜
- ğŸ”’ **ì½”ë“œ ì•ˆì „ì„±**: ë¦¬íŒ©í† ë§ ì‹œ ì‹¤ìˆ˜ ë°©ì§€

**ì´ì œ ë”ìš± ì•ˆì •ì ì´ê³  íš¨ìœ¨ì ì¸ ê°€ì¹˜ì£¼ ë°œêµ´ ì‹œìŠ¤í…œì´ ì™„ì„±ë˜ì—ˆìŠµë‹ˆë‹¤!** ğŸ¯ğŸ’

---

**ë²„ì „**: v2.1.3 (ì¹˜ëª…ì  ì´ìŠˆ ìˆ˜ì •)  
**ë‚ ì§œ**: 2025-01-11  
**ìƒíƒœ**: âœ… í•µì‹¬ ìˆ˜ì • ì™„ë£Œ  
**ë‹¤ìŒ**: v2.2 (UX ëŒ€í­ ê°œì„ )
