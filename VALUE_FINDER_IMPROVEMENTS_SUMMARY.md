# 가치주 발굴 시스템 개선 사항 요약

## 📋 개요
사용자 피드백을 바탕으로 `value_stock_finder.py`의 핵심 리스크를 해결하고 실제 초과수익으로 이어지도록 개선했습니다.

**작업 일시**: 2025-01-11
**개선 버전**: v2.0 (Enhanced)

---

## ✅ 완료된 주요 개선사항

### 1. 음수 PER 대체 로직 구현 ✅
**문제**: 음수 PER(적자) 종목이 구조적으로 배제되어 경기 저점의 진짜 가치주를 놓침

**해결**:
- `AlternativeValuationMetrics` 클래스 구현
- EV/Sales, P/S 기반 대체 점수 계산 (최대 20점)
- 흑자 전환 징후 평가 (영업이익률 개선, 매출 성장)
- 음수 PER 시 자동으로 대체 밸류에이션 적용
- 대체 평가 사용 시 패널티 면제

**코드 위치**:
- `value_finder_improvements.py`: `AlternativeValuationMetrics`
- `value_stock_finder.py`: line 1365-1376 (evaluate_value_stock 내)

**효과**:
- 일시적 적자 우량주 발굴 가능
- 경기 사이클 저점에서의 미스(miss) 감소

---

### 2. 품질 지표 추가 (FCF Yield, Interest Coverage, Piotroski F-Score) ✅
**문제**: 현금흐름·재무건전성 평가가 약해서 가치 함정 위험

**해결**:
- **FCF Yield** (0-15점): 시가총액 대비 잉여현금흐름
  - 10% 이상: 15점
  - 7-10%: 12점
  - 5-7%: 9점
  
- **Interest Coverage** (0-10점): 이자보상배율
  - 10x 이상: 10점
  - 5-10x: 8점
  - 3-5x: 6점
  
- **Piotroski F-Score** (0-18점): 9개 항목 품질 평가
  - 수익성 (4점): 순이익, CFO, ROA 증가, 발생액 품질
  - 레버리지/유동성 (3점): 부채 감소, 유동비율 증가, 희석 방지
  - 운영효율성 (2점): 매출총이익률, 자산회전율 증가

**코드 위치**:
- `value_finder_improvements.py`: `QualityMetricsCalculator`
- `value_stock_finder.py`: line 1378-1427

**효과**:
- 가치 함정(저PER이지만 부실 기업) 회피
- 이익의 질(현금흐름) 검증
- 재무건전성 명확한 평가

---

### 3. 데이터 품질 가드 추가 ✅
**문제**: 외부 모듈 실패 시 더미 값(0)으로 잘못된 추천

**해결**:
- **더미 데이터 검증**: 주요 지표의 50% 이상이 0/None이면 평가 제외
- **회계 이상 징후 감지**:
  - 일회성 손익 비중 > 50%
  - 현금흐름/순이익 괴리 (CFO < NI × 0.5)
  - 매출채권/재고자산 급증 (전년 대비 2배 이상)
- **데이터 신선도 체크**: 180일 이상 오래된 데이터 경고

**코드 위치**:
- `value_finder_improvements.py`: `DataQualityGuard`
- `value_stock_finder.py`: line 1333-1346

**효과**:
- 데이터 오류로 인한 오판 방지
- 회계 조작 위험 종목 경고
- 추천 품질 향상

---

### 4. 섹터 보너스 이중카운팅 제거/축소 ✅
**문제**: 섹터 보너스(최대 25점)가 기본 점수와 동일 정보 반복 반영

**해결**:
- 섹터 보너스 최대점수 축소: 25점 → **10점**
- 개별 기준 점수 조정:
  - PER 충족: 5점 → **3점**
  - PBR 충족: 5점 → **3점**
  - ROE 충족: 5점 → **4점**
- 3개 기준 완벽 충족 시 추가 보너스 **제거** (이중카운팅 방지)

**코드 위치**:
- `value_stock_finder.py`: line 1429-1458

**효과**:
- 점수 체계 명확화
- 이중카운팅 제거로 공정한 평가

---

### 5. 테스트 훅/로깅 강화 ✅
**문제**: 추천 사유 디버깅 어려움

**해결**:
- 종목별 상세 평가 결과를 JSON으로 저장 (`logs/debug_evaluations/`)
- 로깅 내용:
  - 점수 구성 요소 (PER/PBR/ROE, 품질, 섹터, MoS)
  - 백분율 점수 및 최대 가능 점수
  - 추천 등급 및 사유
  - 원시 지표 (PER, PBR, ROE, 시가총액, 현재가)
  - 회계 이상 징후 (있을 경우)

**코드 위치**:
- `value_stock_finder.py`: line 1566-1591

**효과**:
- 추천 사유 투명성 확보
- 백테스트 및 사후 분석 용이
- 디버깅 시간 단축

---

### 6. 점수 체계 재조정 ✅
**문제**: 품질 지표 추가로 총점 변경, 기존 등급 기준 부적합

**변경 전**: 최대 120점 (PER/PBR/ROE 60 + 섹터 25 + MoS 35)
**변경 후**: 최대 **148점** (PER/PBR/ROE 60 + 품질 43 + 섹터 10 + MoS 35)

**등급 기준 (백분율 기반)**:
- A+ (매우 우수): 75% 이상 (111점 이상)
- A (우수): 65-75% (96-110점)
- B+ (양호): 55-65% (81-95점)
- B (보통): 45-55% (67-80점)
- C+ (주의): 35-45% (52-66점)
- C (위험): 35% 미만 (51점 이하)

**추천 기준 (백분율 기반)**:
- STRONG_BUY: 65% 이상 또는 3개 기준 충족 + 60% 이상
- BUY: 55% 이상 또는 2개 이상 기준 충족 + 50% 이상
- HOLD: 45% 이상
- SELL: 45% 미만

**하드 가드**:
- ROE < 0 and PBR > 3 → SELL
- 회계 이상 징후 HIGH → 최대 HOLD

**코드 위치**:
- `value_stock_finder.py`: line 1486-1565

---

## 🚧 진행 중 / 향후 개선사항

### 7. 장기 앵커 기반 MoS 계산 (진행 중)
**목표**: 프로사이클(친상승장) 편향 완화

**현재 상태**:
- `LongTermAnchorCache` 클래스 구현 완료
- 5년/10년 장기 중앙값 캐싱 시스템 구축
- TTL 90일, 자동 갱신 지원

**남은 작업**:
- `calculate_intrinsic_value` 함수에서 현재 섹터 중값 → 장기 중값 사용
- `compute_mos_score` 함수에 장기 앵커 통합
- 장기 통계 데이터 수집 (최소 36개월 필요)

**우선순위**: 중 (데이터 확보 후 진행)

---

### 8. 백테스트 프레임워크 기반 점수 컷오프 재학습 (미착수)
**목표**: 경험적 임계값을 데이터 기반으로 최적화

**필요 작업**:
- 리밸런스 주기별 시뮬레이션 (월/분기)
- 거래비용·슬리피지 반영
- 상장·상폐 동학 포함
- 성과 지표: 연환산 수익률, 샤프 비율, MDD, 알파/베타
- 그리드서치/베이지안 최적화로 점수 컷오프 학습

**우선순위**: 중 (별도 모듈로 구현 필요)

---

## 📊 개선 효과 요약

| 항목 | 개선 전 | 개선 후 | 효과 |
|------|---------|---------|------|
| **음수 PER 처리** | 자동 탈락 | 대체 평가 (EV/Sales, P/S) | 경기 저점 종목 발굴 |
| **품질 평가** | 약함 | FCF Yield + Interest Coverage + F-Score | 가치 함정 회피 |
| **데이터 검증** | 없음 | 더미 데이터 감지 + 회계 이상 징후 | 오판 방지 |
| **섹터 보너스** | 최대 25점 (중복) | 최대 10점 (단순화) | 이중카운팅 제거 |
| **로깅** | 기본 | JSON 상세 로깅 | 디버깅 용이 |
| **점수 체계** | 120점 만점 | 148점 만점 (백분율) | 명확한 기준 |
| **프로사이클 편향** | 높음 | 진행 중 (장기 앵커) | 향후 완화 |

---

## 🔧 사용 방법

### 1. 개선 모듈 설치
```bash
# value_finder_improvements.py가 프로젝트 루트에 있는지 확인
# 필요한 경우 추가 패키지 설치
pip install pickle5  # Python < 3.8
```

### 2. 실행
```bash
# Streamlit UI로 실행
streamlit run value_stock_finder.py

# 또는 Python 스크립트로 실행
python value_stock_finder.py
```

### 3. 디버그 로그 확인
```bash
# 종목별 상세 평가 결과
ls logs/debug_evaluations/*.json

# 특정 종목 로그 확인
cat logs/debug_evaluations/005930_*.json | jq '.'
```

---

## 📚 참고 자료

### 이론적 배경
1. **Piotroski F-Score**: Joseph Piotroski (2000) - "Value Investing: The Use of Historical Financial Statement Information to Separate Winners from Losers"
2. **Justified Multiples**: CFA Level II Equity Valuation
3. **FCF Yield**: Free Cash Flow to Equity / Market Cap
4. **Interest Coverage**: EBIT / Interest Expense

### 관련 파일
- `value_finder_improvements.py`: 개선 모듈 (독립 실행 가능)
- `value_stock_finder.py`: 메인 시스템 (개선 통합)
- `config.yaml`: 설정 파일
- `logs/debug_evaluations/`: 디버그 로그

---

## 🐛 알려진 이슈 및 제한사항

1. **장기 앵커 데이터 부족**
   - 현재: 최소 36개월 데이터 필요
   - 해결: 데이터 수집 후 캐시 구축

2. **Piotroski F-Score 계산 데이터 부족**
   - 일부 종목에서 전년도 데이터 미제공
   - 폴백: F-Score 없이 다른 지표로 평가

3. **백테스트 미완료**
   - 점수 컷오프가 경험적 기준
   - 해결: 향후 백테스트 프레임워크 구축

---

## 💡 추천 사용 팁

1. **필터링 순서**
   - 1단계: 데이터 품질 가드 통과
   - 2단계: 점수 60% 이상 (BUY 이상)
   - 3단계: 회계 이상 징후 없음
   - 4단계: Piotroski F-Score 6점 이상

2. **포트폴리오 구성**
   - STRONG_BUY: 60-70%
   - BUY: 30-40%
   - 3-5종목 분산 투자

3. **리밸런싱**
   - 분기별 1회 (3개월마다)
   - 등급 C 이하로 하락 시 즉시 매도 검토

---

## 🎯 결론

**현재 시스템은 "비싸지 않은 우량주 후보"를 빠르게 압축하는 데 유용하며, 개선사항 적용으로 다음이 가능해졌습니다**:

✅ 가치 함정 회피 (품질 지표)
✅ 음수 PER 종목 평가 (대체 밸류에이션)
✅ 데이터 오류 방지 (품질 가드)
✅ 투명한 추천 사유 (디버그 로깅)
✅ 명확한 점수 체계 (백분율 기반)

**향후 장기 성과 검증과 백테스트를 통해 실제 초과수익과 리스크 관리에 의미 있게 기여하는 가치주 발굴기가 될 것입니다.**

---

**작성자**: AI Assistant (Claude Sonnet 4.5)
**검토**: 사용자 피드백 기반
**다음 업데이트**: 장기 앵커 통합 및 백테스트 완료 후

