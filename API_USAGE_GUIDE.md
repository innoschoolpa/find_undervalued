# KIS API 안전 사용 가이드

## 🚨 중요: AppKey 차단 방지

한국투자증권 OpenAPI는 **유량 초과 시 AppKey를 일시 차단**합니다.

### 공식 유량 제한

```
실전투자: 20건/초 (0.05초 간격)
모의투자: 2건/초 (0.5초 간격)
```

### ⚠️ 차단 발생 조건

1. **초당 거래건수 초과** (오류코드: EGW00201)
2. **전체 종목 실시간 시세 요청** (과도한 부하)
3. **연속적인 대량 호출** (50개 이상 종목 빠르게 조회)

### 🔒 차단 시 증상

- 모든 API 요청이 **500 에러** 반환
- 재시도, 세션 재생성 모두 실패
- **차단 해제까지 해당 AppKey 사용 불가**

### ⏱️ 차단 해제 시간 (한투 공식 답변)

| 차단 사유 | 해제 시간 | 자동/수동 |
|-----------|-----------|-----------|
| 초당 거래건수 초과 (EGW00201) | **수 초 ~ 수 분** | 자동 해제 |
| 과도한 실시간 요청 | 수 분 ~ 수 시간 | 자동 또는 수동 |
| 약관 위반/시스템 과부하 | 자동 해제 안 됨 | 고객센터 필수 |

**일반적인 경우: 5~10분 내 회복** ✅

### ✅ 현재 안전 설정 (2025-01-09 수정)

```python
# mcp_kis_integration.py

request_interval = 0.5초      # 2건/초 (실전투자 20건/초의 10%)
슬로우 모드 = 2.0초           # 0.5건/초 (차단 복구 모드)
슬로우 모드 지속 = 120초      # 2분간 유지
연속 500 에러 제한 = 2회      # 빠른 차단 감지
세션 재생성 대기 = 60초       # 차단 복구 대기
```

### 📊 성능 비교

| 설정 | 간격 | 속도 | 50개 종목 | 안전성 |
|------|------|------|-----------|--------|
| **이전** (위험) | 0.15초 | 6.7건/초 | 7.5초 | ❌ 차단 위험 |
| **현재** (안전) | 0.5초 | 2건/초 | 25초 | ✅ 장기 운영 |
| **권장** (보수) | 1.0초 | 1건/초 | 50초 | ✅✅ 최대 안전 |

### 🛠️ 차단 발생 시 조치

#### 1단계: 즉시 중단 및 대기
1. ⏸️ **모든 API 호출 즉시 중단**
2. ⏰ **5~10분 대기** (일반적인 경우 자동 해제)
3. 🧪 **소량 테스트** - 1~2개 종목으로 복구 확인

#### 2단계: 복구 후 재설정
1. ✅ **간격 증가** - `request_interval=1.0` (1건/초)
2. 🔍 **소량부터 시작** - 10~20개 종목만
3. 📊 **점진적 증가** - 문제 없으면 서서히 확대

#### 3단계: 장시간 차단 시
- ⏳ **10분 이상 지속** → 30분~1시간 대기
- 📞 **1시간 이상 지속** → 고객센터 문의
  - 전화: 1544-5000 (평일 09:00~18:00)
  - 고객의소리: https://www.truefriend.com/main/customer/support/Support.jsp?cmd=agree_3

### 💡 안전 운영 팁

1. **소량으로 시작** - 처음엔 10~20개 종목만 조회
2. **점진적 증가** - 문제 없으면 서서히 늘림
3. **장중 피크 시간 회피** - 09:00~09:30, 15:00~15:30
4. **주기적 휴식** - 50개 조회 후 30초 대기
5. **캐시 활용** - 동일 데이터 재조회 방지

### 📞 문제 발생 시

```
한국투자증권 OpenAPI 고객센터
전화: 1544-5000
운영: 평일 09:00~18:00
```

### 🔧 수동 간격 조정

장기 운영 시 더 보수적으로 설정:

```python
# value_stock_finder.py 또는 초기화 부분
mcp = MCPKISIntegration(oauth, request_interval=1.0)  # 1건/초
```

### ⚙️ 버전 히스토리

- **2025-01-09**: 0.5초 간격으로 변경 (AppKey 차단 방지)
- 이전: 0.15초 간격 (차단 위험 확인)

---

**⚠️ 주의**: 이 설정은 실제 차단 사례를 바탕으로 작성되었습니다.  
안전한 운영을 위해 권장 설정을 준수하세요.

