"""
KIS API + DART API í†µí•© ì‹œê°€ì´ì•¡ ìƒìœ„ ì¢…ëª© ì¡°íšŒ ì‹œìŠ¤í…œ
"""

import logging
from typing import List, Dict, Any, Optional
import time
from datetime import datetime

from kis_data_provider import KISDataProvider
from dart_data_provider import DartDataProvider

logger = logging.getLogger(__name__)

class IntegratedMarketCapProvider:
    """KIS APIì™€ DART APIë¥¼ í†µí•©í•œ ì‹œê°€ì´ì•¡ ìƒìœ„ ì¢…ëª© ì¡°íšŒ í´ë˜ìŠ¤"""
    
    def __init__(self, config_path: str = "config.yaml"):
        """í†µí•© ë°ì´í„° ì œê³µì ì´ˆê¸°í™”"""
        try:
            self.kis_provider = KISDataProvider(config_path)
            logger.info("âœ… KIS API ì´ˆê¸°í™” ì™„ë£Œ")
        except Exception as e:
            logger.error(f"KIS API ì´ˆê¸°í™” ì‹¤íŒ¨: {e}")
            self.kis_provider = None
        
        try:
            self.dart_provider = DartDataProvider(config_path)
            logger.info("âœ… DART API ì´ˆê¸°í™” ì™„ë£Œ")
        except Exception as e:
            logger.error(f"DART API ì´ˆê¸°í™” ì‹¤íŒ¨: {e}")
            self.dart_provider = None
        
        logger.info("ğŸ” í†µí•© ì‹œê°€ì´ì•¡ ì¡°íšŒ ì‹œìŠ¤í…œ ì´ˆê¸°í™” ì™„ë£Œ")
    
    def get_top_stocks_by_market_cap(self, max_count: int = 250) -> List[Dict[str, Any]]:
        """ì‹œê°€ì´ì•¡ ìƒìœ„ ì¢…ëª© ì¡°íšŒ (í†µí•© ë°©ì‹)"""
        logger.info(f"ğŸ” í†µí•© ë°©ì‹ìœ¼ë¡œ ì‹œê°€ì´ì•¡ ìƒìœ„ {max_count}ê°œ ì¢…ëª© ì¡°íšŒ ì‹œì‘")
        
        try:
            # DART APIê°€ ì—†ìœ¼ë©´ KIS APIë§Œ ì‚¬ìš©
            if not self.dart_provider:
                logger.warning("DART APIë¥¼ ì‚¬ìš©í•  ìˆ˜ ì—†ìŒ. KIS APIë§Œ ì‚¬ìš©")
                return self._get_top_stocks_kis_only(max_count)
            
            # KIS APIê°€ ì—†ìœ¼ë©´ DART APIë§Œ ì‚¬ìš©
            if not self.kis_provider:
                logger.warning("KIS APIë¥¼ ì‚¬ìš©í•  ìˆ˜ ì—†ìŒ. DART APIë§Œ ì‚¬ìš©")
                return self._get_top_stocks_dart_only(max_count)
            
            # 1ë‹¨ê³„: KIS APIë¡œ í˜„ì¬ê°€ ì •ë³´ ìˆ˜ì§‘
            logger.info("ğŸ“Š 1ë‹¨ê³„: KIS APIë¡œ í˜„ì¬ê°€ ì •ë³´ ìˆ˜ì§‘")
            current_prices = self._get_current_prices_from_kis(max_count * 2)
            
            if not current_prices:
                logger.warning("KIS APIì—ì„œ í˜„ì¬ê°€ ì •ë³´ë¥¼ ê°€ì ¸ì˜¬ ìˆ˜ ì—†ìŒ. DART APIë§Œ ì‚¬ìš©")
                return self._get_top_stocks_dart_only(max_count)
            
            # 2ë‹¨ê³„: DART APIë¡œ ì‹œê°€ì´ì•¡ ê³„ì‚°
            logger.info("ğŸ“Š 2ë‹¨ê³„: DART APIë¡œ ì‹œê°€ì´ì•¡ ê³„ì‚°")
            top_stocks = self.dart_provider.get_top_stocks_by_market_cap(max_count, current_prices)
            
            if not top_stocks:
                logger.warning("DART APIì—ì„œ ì‹œê°€ì´ì•¡ ì •ë³´ë¥¼ ê°€ì ¸ì˜¬ ìˆ˜ ì—†ìŒ. KIS APIë§Œ ì‚¬ìš©")
                return self._get_top_stocks_kis_only(max_count)
            
            # 3ë‹¨ê³„: ë°ì´í„° í†µí•© ë° ê²€ì¦
            logger.info("ğŸ“Š 3ë‹¨ê³„: ë°ì´í„° í†µí•© ë° ê²€ì¦")
            integrated_stocks = self._integrate_and_validate_data(top_stocks, current_prices)
            
            # 4ë‹¨ê³„: ì‹œê°€ì´ì•¡ ìˆœìœ¼ë¡œ ì •ë ¬
            integrated_stocks.sort(key=lambda x: x.get('market_cap', 0), reverse=True)
            
            # ìƒìœ„ Nê°œ ë°˜í™˜
            final_stocks = integrated_stocks[:max_count]
            
            logger.info(f"âœ… í†µí•© ë°©ì‹ìœ¼ë¡œ ì‹œê°€ì´ì•¡ ìƒìœ„ {len(final_stocks)}ê°œ ì¢…ëª© ì¡°íšŒ ì™„ë£Œ")
            
            return final_stocks
            
        except Exception as e:
            logger.error(f"í†µí•© ì‹œê°€ì´ì•¡ ì¡°íšŒ ì‹¤íŒ¨: {e}")
            # í´ë°±: KIS APIë§Œ ì‚¬ìš©
            return self._get_top_stocks_kis_only(max_count)
    
    def _get_current_prices_from_kis(self, max_count: int) -> Dict[str, float]:
        """KIS APIë¡œ í˜„ì¬ê°€ ì •ë³´ ìˆ˜ì§‘"""
        try:
            # KIS APIë¡œ ì¢…ëª© ë¦¬ìŠ¤íŠ¸ ì¡°íšŒ
            stocks = self.kis_provider.get_kospi_stock_list(max_count)
            
            current_prices = {}
            for stock in stocks:
                if isinstance(stock, dict) and 'code' in stock:
                    code = stock['code']
                    price = stock.get('current_price', 0)
                    if price > 0:
                        current_prices[code] = price
            
            logger.info(f"ğŸ“Š KIS APIì—ì„œ {len(current_prices)}ê°œ ì¢…ëª©ì˜ í˜„ì¬ê°€ ìˆ˜ì§‘")
            return current_prices
            
        except Exception as e:
            logger.error(f"KIS API í˜„ì¬ê°€ ìˆ˜ì§‘ ì‹¤íŒ¨: {e}")
            return {}
    
    def _get_top_stocks_dart_only(self, max_count: int) -> List[Dict[str, Any]]:
        """DART APIë§Œ ì‚¬ìš©í•˜ì—¬ ìƒìœ„ ì¢…ëª© ì¡°íšŒ"""
        try:
            logger.info("ğŸ“Š DART APIë§Œ ì‚¬ìš©í•˜ì—¬ ìƒìœ„ ì¢…ëª© ì¡°íšŒ")
            return self.dart_provider.get_top_stocks_by_market_cap(max_count)
        except Exception as e:
            logger.error(f"DART API ë‹¨ë… ì¡°íšŒ ì‹¤íŒ¨: {e}")
            return []
    
    def _get_top_stocks_kis_only(self, max_count: int) -> List[Dict[str, Any]]:
        """KIS APIë§Œ ì‚¬ìš©í•˜ì—¬ ìƒìœ„ ì¢…ëª© ì¡°íšŒ (ê¸°ì¡´ ë°©ì‹)"""
        try:
            logger.info("ğŸ“Š KIS APIë§Œ ì‚¬ìš©í•˜ì—¬ ìƒìœ„ ì¢…ëª© ì¡°íšŒ")
            stocks = self.kis_provider.get_kospi_stock_list(max_count)
            
            # KIS API ì‘ë‹µì„ í‘œì¤€ í˜•ì‹ìœ¼ë¡œ ë³€í™˜
            formatted_stocks = []
            for stock in stocks:
                if isinstance(stock, dict):
                    formatted_stocks.append({
                        'code': stock.get('code', ''),
                        'name': stock.get('name', ''),
                        'market_cap': stock.get('market_cap', 0),
                        'current_price': stock.get('current_price', 0),
                        'per': stock.get('per', 0),
                        'pbr': stock.get('pbr', 0),
                        'roe': stock.get('roe', 0),
                        'sector': stock.get('sector', ''),
                        'source': 'kis_only'
                    })
            
            return formatted_stocks
            
        except Exception as e:
            logger.error(f"KIS API ë‹¨ë… ì¡°íšŒ ì‹¤íŒ¨: {e}")
            return []
    
    def _integrate_and_validate_data(self, dart_stocks: List[Dict[str, Any]], current_prices: Dict[str, float]) -> List[Dict[str, Any]]:
        """DART ë°ì´í„°ì™€ KIS ë°ì´í„° í†µí•© ë° ê²€ì¦"""
        integrated_stocks = []
        
        for dart_stock in dart_stocks:
            code = dart_stock.get('code', '')
            
            # KIS APIì—ì„œ ì¶”ê°€ ì •ë³´ ì¡°íšŒ
            kis_info = self._get_kis_additional_info(code)
            
            # ë°ì´í„° í†µí•©
            integrated_stock = {
                'code': code,
                'name': dart_stock.get('name', ''),
                'market_cap': dart_stock.get('market_cap', 0),
                'current_price': current_prices.get(code, dart_stock.get('current_price', 0)),
                'per': kis_info.get('per', 0),
                'pbr': kis_info.get('pbr', 0),
                'roe': kis_info.get('roe', 0),
                'sector': kis_info.get('sector', ''),
                'source': 'integrated',
                'dart_corp_code': dart_stock.get('corp_code', '')
            }
            
            # ë°ì´í„° ê²€ì¦
            if self._validate_stock_data(integrated_stock):
                integrated_stocks.append(integrated_stock)
        
        logger.info(f"ğŸ“Š ë°ì´í„° í†µí•© ì™„ë£Œ: {len(integrated_stocks)}ê°œ ì¢…ëª©")
        return integrated_stocks
    
    def _get_kis_additional_info(self, stock_code: str) -> Dict[str, Any]:
        """KIS APIì—ì„œ ì¶”ê°€ ì •ë³´ ì¡°íšŒ"""
        try:
            stock_info = self.kis_provider.get_stock_price_info(stock_code)
            if stock_info:
                return {
                    'per': stock_info.get('per', 0),
                    'pbr': stock_info.get('pbr', 0),
                    'roe': stock_info.get('eps', 0) / stock_info.get('bps', 1) * 100 if stock_info.get('bps', 0) > 0 else 0,
                    'sector': stock_info.get('sector', '')
                }
        except Exception as e:
            logger.debug(f"KIS API ì¶”ê°€ ì •ë³´ ì¡°íšŒ ì‹¤íŒ¨: {stock_code} - {e}")
        
        return {}
    
    def _validate_stock_data(self, stock_data: Dict[str, Any]) -> bool:
        """ì¢…ëª© ë°ì´í„° ê²€ì¦"""
        # í•„ìˆ˜ í•„ë“œ ê²€ì¦
        required_fields = ['code', 'name', 'market_cap']
        for field in required_fields:
            if not stock_data.get(field):
                return False
        
        # ì‹œê°€ì´ì•¡ ê²€ì¦ (ìµœì†Œ 100ì–µì›)
        market_cap = stock_data.get('market_cap', 0)
        if market_cap < 10000000000:  # 100ì–µì›
            return False
        
        # ì£¼ê°€ ê²€ì¦ (ìµœì†Œ 100ì›)
        current_price = stock_data.get('current_price', 0)
        if current_price < 100:
            return False
        
        return True
    
    def get_market_cap_ranking(self, max_count: int = 250) -> List[Dict[str, Any]]:
        """ì‹œê°€ì´ì•¡ ìˆœìœ„ ì¡°íšŒ (ë³„ì¹­)"""
        return self.get_top_stocks_by_market_cap(max_count)
    
    def get_stock_universe(self, max_count: int = 250) -> Dict[str, str]:
        """ì¢…ëª© ìœ ë‹ˆë²„ìŠ¤ ì¡°íšŒ (ê¸°ì¡´ ì¸í„°í˜ì´ìŠ¤ í˜¸í™˜)"""
        stocks = self.get_top_stocks_by_market_cap(max_count)
        
        # ê¸°ì¡´ ì¸í„°í˜ì´ìŠ¤ì— ë§ê²Œ ë³€í™˜
        universe = {}
        for stock in stocks:
            code = stock.get('code', '')
            name = stock.get('name', '')
            if code and name:
                universe[code] = name
        
        logger.info(f"ğŸ“Š ì¢…ëª© ìœ ë‹ˆë²„ìŠ¤ ìƒì„±: {len(universe)}ê°œ ì¢…ëª©")
        return universe

def main():
    """í…ŒìŠ¤íŠ¸ í•¨ìˆ˜"""
    try:
        provider = IntegratedMarketCapProvider()
        
        # ì‹œê°€ì´ì•¡ ìƒìœ„ 10ê°œ ì¢…ëª© ì¡°íšŒ í…ŒìŠ¤íŠ¸
        top_stocks = provider.get_top_stocks_by_market_cap(10)
        
        print(f"ì‹œê°€ì´ì•¡ ìƒìœ„ 10ê°œ ì¢…ëª©:")
        for i, stock in enumerate(top_stocks, 1):
            print(f"{i:2d}. {stock['code']}: {stock['name']} - {stock['market_cap']:,.0f}ì›")
        
        # ì¢…ëª© ìœ ë‹ˆë²„ìŠ¤ ì¡°íšŒ í…ŒìŠ¤íŠ¸
        universe = provider.get_stock_universe(10)
        print(f"\nì¢…ëª© ìœ ë‹ˆë²„ìŠ¤: {len(universe)}ê°œ ì¢…ëª©")
        for code, name in list(universe.items())[:5]:
            print(f"  {code}: {name}")
            
    except Exception as e:
        logger.error(f"í†µí•© ì‹œê°€ì´ì•¡ ì¡°íšŒ í…ŒìŠ¤íŠ¸ ì‹¤íŒ¨: {e}")

if __name__ == "__main__":
    main()
